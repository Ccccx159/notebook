# 使用公网IPv6远程访问内网设备



## 一、前言

IPv4公网IP一号难求的环境下，如何优雅的使用公网IPv6进行远程访问？本文将以中国移动的宽带和光猫为例，进行IPv6的设置说明，并实现通过IPv6地址和Windows系统自带的远程工具"mstsc"，远程访问内网的Windows主机。

可能部分宽带安装师傅默认没有打开 IPv6 的功能，因此我们先登录光猫的后台确认光猫是否开启了 IPv6。由于电信的宽带服务相对比较容易获取到公网IPv4地址，因此这里以移动宽带举例，其他宽带运营商提供的光猫可能有所差异，但是功能大同小异，请自行搜索相应操作细节。

## 二、确认IPv6连接状态

如果宽带是由光猫拨号连接的，在浏览器中输入光猫的后台地址，例如 `192.168.1.1`，移动光猫的后台界面如下图所示。一般来说，移动光猫的管理员账号和密码是相同的，曾经在同一省份的不同城市都办理过移动宽带，光猫后台的账号密码都如图中所示 `账号：CMCCAdmin  密码：aDm8H%MdA` 。不确定不同省份是否有所差异，如果这个账号密码不可用，请自行搜索或者向宽带运营商索取。

![](https://user-images.githubusercontent.com/35327600/223893633-286b2a64-fbe5-4f88-b4b1-ed7ea31af0d4.png)

点击确定后，进入后台界面，按下图中所标识的按钮和顺序，依次点击，可以在当前界面查看到 IPv6 的连接信息。

![](https://user-images.githubusercontent.com/35327600/223897533-878fed3e-07c9-4912-8679-dc645432fefb.png)

如果确定 IPv6 已正确连接，在上图界面中，可以拉动横向的滚动条，查看当前的 IPv6 地址。

![](https://user-images.githubusercontent.com/35327600/226225202-a8abe3c7-357b-4a32-83b4-2e618983d270.png)

如果上述界面中显示IPv6未连接，请根据以下界面检查运营商是否给当前宽带套餐开通IPv6功能。

![](https://user-images.githubusercontent.com/35327600/226227385-07eb44f5-9836-47d3-89ef-7237f855b369.png)


## 三、打开并查看远程主机IPv6地址

这里以win10系统为例，可能部分人的PC默认没有开启IPv6，按照以下步骤打开IPv6，并获取IPv6地址。

1. 按下 "windows徽标" + "R"，打开运行窗口，输入 "ncpa.cpl" 后回车，打开网络适配器管理界面
	![](https://user-images.githubusercontent.com/35327600/226231169-7eb0ce41-e3b9-429b-b9b2-06306351b0a5.png)
	![](https://user-images.githubusercontent.com/35327600/226231296-153119ad-ce30-4477-ac49-2e53a3a88316.png)
2. 双击以太网连接，查看当前以太网状态，若IPv6连接显示无网络连接，则按以下图片内说明打开IPv6连接
	![](https://user-images.githubusercontent.com/35327600/226232249-91264fa3-74f0-44d1-891b-64f0ba50561c.png)
	![](https://user-images.githubusercontent.com/35327600/226233016-617c197b-32e8-4d0e-bbdf-d36cac0deb69.png)
	![](https://user-images.githubusercontent.com/35327600/226234598-aa6dba1e-1b3c-4928-a1ea-5ae0794f61f0.png)

## 四、打开本地PC的IPv6连接

由于需要使用IPv6进行远程连接，需要确保本地 PC 和远程 PC 同时具备 IPv6 的连接能力，因此对于本地PC，也需要按照上述**第2步**进行确认。

> 远程PC和本地PC可使用浏览器访问[IPv6测试网站](http://ipv6.test-ipv6.com)进行连接测试。

完成两端的 IPv6 连接设置后，可以直接使用 IPv6 地址尝试远程连接，不出意外，此时已经可以成功进行远程访问了。
+ 按下 "windows 徽标" + "R"，打开运行界面，输入 "mstsc"，回车，打开远程连接界面，填入第二步中获取的"**远程 PC 的 IPv6 地址**"，点击连接。正常情况下，此时会弹出要求输入用户名和密码。
	![](https://user-images.githubusercontent.com/35327600/226236201-a851eec6-c3a7-40dd-b6f0-70f4e48889c2.png)

## 五、遇到的坑

整个过程可能会存在两个坑，导致无法连接：
1. 光猫默认使能IPv6防火墙的控制转发报文功能（作者的移动光猫中是这么描述的），导致所有的IPv6数据包被拦截，从而无法建立远程连接，甚至无法 ping 通。需要将该功能关闭，才能正常使用IPv6。
	![](https://user-images.githubusercontent.com/35327600/226237991-c5b5cadb-0837-40c6-aa1d-48d968927ce3.png)
2. 远程PC未打开远程访问功能。win10家庭版不支持远程桌面，专业版则默认关闭了远程桌面，因此需要手动打开和确认。
	![](https://user-images.githubusercontent.com/35327600/226238918-83374ecb-6640-4c8e-87bd-2153e81124ac.png)
	![](https://user-images.githubusercontent.com/35327600/226239110-a296c35e-5546-4a3d-b5cb-913901ac9121.png)
3. 部分网络默认不开启IPv6，例如公司内部网络等，因此远程PC虽然开启了IPv6，但仍然无法通过IPv6进行远程连接；

## 六、存在的缺陷

按步骤完成上述操作后，一般来说，已经能成功使用IPv6地址进行远程访问。但是使用起来仍然存在2个比较致命的问题：
1. IPv6 地址很长，不方便记忆；
2. 公网 IPv6 地址并非固定不变，在一定情况下，地址发生变更，如果不能及时获取地址，则无法进行远程访问

针对第一个缺陷，由于域名可以自定义申请，并且方便记忆，因此我们可以申请一个域名（例如 baidu.com、google.com），并将域名解析到对应IP地址（DNS服务商提供解析服务），通过域名来进行访问。

而第二个缺陷，在域名的基础上，我们还需要定期将当前的IP地址，同步给DNS服务商，修改域名解析的目标IP，确保域名能正确解析到我们自己的设备上。

由于文章篇幅较长，因此将在下一篇文章中进行详细说明介绍~

